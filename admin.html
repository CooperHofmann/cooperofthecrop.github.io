<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | COOPEROFTHECROP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --black: #000000;
            --white: #FAF9F6;
            --accent: #FF462E;
            --gray: #808080;
            --light-gray: #E0E0E0;
            --success: #00AA00;
            --warning: #FF9900;
            --danger: #CC0000;
            --blue: #0066CC;
        }
        
        body {
            font-family: Helvetica, Arial, sans-serif;
            background: var(--white);
            color: var(--black);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* PIN Authentication Modal */
        .pin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .pin-modal.hidden {
            display: none;
        }

        .pin-content {
            background: var(--white);
            border: 4px solid var(--black);
            padding: 60px 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .pin-content h2 {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 36px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 20px;
            letter-spacing: -0.02em;
        }

        .pin-content p {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 16px;
        }

        .pin-input-wrapper {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .pin-digit {
            width: 60px;
            height: 80px;
            border: 4px solid var(--black);
            font-family: Helvetica, Arial, sans-serif;
            font-size: 36px;
            font-weight: 700;
            text-align: center;
            background: var(--light-gray);
            transition: all 0.2s ease;
        }

        .pin-digit:focus {
            outline: none;
            border-color: var(--blue);
            background: var(--white);
        }

        .pin-error {
            color: var(--danger);
            font-weight: 600;
            margin-top: 10px;
            display: none;
        }

        .pin-error.show {
            display: block;
        }

        /* Admin Container */
        .admin-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
            background: var(--white);
        }

        .admin-container.active {
            display: block;
        }

        /* Header - Swiss Grid Layout */
        .admin-header {
            background: var(--black);
            color: var(--white);
            padding: 40px;
            margin-bottom: 60px;
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 40px;
        }

        .admin-header h1 {
            font-family: Helvetica, Arial, sans-serif;
            font-size: clamp(28px, 4vw, 42px);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: -0.02em;
            line-height: 1.1;
        }

        .admin-header .actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Stats Cards - Swiss Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 2px;
            margin-bottom: 60px;
            border: 2px solid var(--black);
        }

        .stat-card {
            background: var(--white);
            border-right: 2px solid var(--black);
            border-bottom: 2px solid var(--black);
            padding: 30px 20px;
            text-align: left;
            transition: background 0.2s ease;
        }

        .stat-card:hover {
            background: var(--light-gray);
        }

        .stat-card .number {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 56px;
            font-weight: 300;
            color: var(--black);
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-card .label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--gray);
            font-weight: 500;
        }

        /* Main Content Area - Swiss Grid */
        .admin-content {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 60px;
        }

        /* Sidebar - Swiss Minimal */
        .admin-sidebar {
            background: var(--black);
            color: var(--white);
            padding: 0;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-menu li:last-child {
            border-bottom: none;
        }

        .sidebar-menu a {
            display: block;
            padding: 20px 25px;
            text-decoration: none;
            color: var(--white);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.15em;
            transition: background 0.2s ease;
            cursor: pointer;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Panel Sections - Clean Swiss Layout */
        .panel-section {
            display: none;
            background: var(--white);
            padding: 0;
        }

        .panel-section.active {
            display: block;
        }

        .panel-section h2 {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 32px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 40px;
            letter-spacing: -0.02em;
            border-bottom: 2px solid var(--black);
            padding-bottom: 20px;
        }

        /* Upload Zone - Swiss Style */
        .upload-zone {
            border: 2px solid var(--black);
            padding: 80px 40px;
            text-align: center;
            background: var(--light-gray);
            margin-bottom: 40px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            background: var(--white);
            border-color: var(--black);
        }

        .upload-zone .icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .upload-zone h3 {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
        }

        .upload-zone p {
            color: var(--gray);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        #fileInput {
            display: none;
        }

        /* Category Selector - Swiss Grid */
        .category-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 2px;
            margin-bottom: 40px;
            border: 2px solid var(--black);
        }

        .category-btn {
            background: var(--light-gray);
            border: none;
            border-right: 2px solid var(--black);
            border-bottom: 2px solid var(--black);
            padding: 20px;
            font-family: Helvetica, Arial, sans-serif;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-btn:hover,
        .category-btn.active {
            background: var(--black);
            color: var(--white);
        }

        /* Photo Grid - Swiss Layout */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 2px;
            margin-top: 40px;
            border: 2px solid var(--black);
        }

        .photo-item {
            position: relative;
            border-right: 2px solid var(--black);
            border-bottom: 2px solid var(--black);
            overflow: hidden;
            aspect-ratio: 1;
            background: var(--light-gray);
            cursor: move;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        
        .photo-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .photo-item.drag-over {
            border-color: var(--black);
            border-width: 4px;
        }
        
        .photo-item .order-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--black);
            color: var(--white);
            padding: 5px 12px;
            font-family: Helvetica, Arial, sans-serif;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.1em;
            z-index: 2;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .photo-item .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 3;
        }
        
        .photo-item .overlay .button-row {
            display: flex;
            gap: 10px;
        }

        .photo-item:hover .overlay {
            opacity: 1;
        }

        .photo-item .overlay button {
            padding: 10px 15px;
            border: 1px solid var(--white);
            background: transparent;
            color: var(--white);
            font-family: Helvetica, Arial, sans-serif;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .photo-item .overlay button:hover {
            background: var(--white);
            color: var(--black);
        }

        /* Buttons - Swiss Minimal */
        .btn {
            background: var(--black);
            color: var(--white);
            border: none;
            padding: 15px 30px;
            font-family: Helvetica, Arial, sans-serif;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            font-weight: 500;
        }

        .btn:hover {
            background: var(--gray);
        }

        .btn-success {
            background: var(--black);
        }

        .btn-success:hover {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #990000;
        }

        .btn-blue {
            background: var(--blue);
        }

        .btn-blue:hover {
            background: #0052A3;
        }

        /* Config Editor */
        .config-editor {
            margin-top: 30px;
        }

        .config-editor textarea {
            width: 100%;
            min-height: 400px;
            background: var(--light-gray);
            border: 3px solid var(--black);
            padding: 20px;
            font-family: Helvetica, Arial, sans-serif;
            font-size: 14px;
            resize: vertical;
            line-height: 1.6;
        }

        .config-editor textarea:focus {
            outline: none;
            border-color: var(--blue);
        }

        /* Instructions Box - Swiss Clean */
        .instructions-box {
            background: var(--light-gray);
            border-left: 4px solid var(--black);
            padding: 30px;
            margin-bottom: 40px;
        }

        .instructions-box h3 {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 20px;
        }

        .instructions-box ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .instructions-box code {
            background: var(--white);
            padding: 2px 8px;
            border: 1px solid var(--black);
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: var(--white);
            border: 3px solid var(--black);
            padding: 20px 30px;
            font-weight: 600;
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .admin-content {
                grid-template-columns: 1fr;
            }

            .admin-sidebar {
                position: static;
            }

            .sidebar-menu {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .sidebar-menu li {
                border-right: 3px solid var(--black);
                border-bottom: none;
            }

            .sidebar-menu li:last-child {
                border-right: none;
            }
        }

        @media (max-width: 768px) {
            .pin-digit {
                width: 50px;
                height: 70px;
                font-size: 28px;
            }

            .admin-header {
                text-align: center;
            }

            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- PIN Authentication Modal -->
    <div id="pinModal" class="pin-modal">
        <div class="pin-content">
            <h2>üîí ADMIN ACCESS</h2>
            <p>Enter your PIN to access the admin panel</p>
            <div class="pin-input-wrapper">
                <input type="password" maxlength="1" class="pin-digit" id="pin1" autofocus>
                <input type="password" maxlength="1" class="pin-digit" id="pin2">
                <input type="password" maxlength="1" class="pin-digit" id="pin3">
                <input type="password" maxlength="1" class="pin-digit" id="pin4">
            </div>
            <div class="pin-error" id="pinError">‚ùå Incorrect PIN. Please try again.</div>
        </div>
    </div>

    <!-- Admin Container -->
    <div id="adminContainer" class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <h1>üì∏ ADMIN DASHBOARD</h1>
            <div class="actions">
                <a href="index.html" class="btn">üè† View Site</a>
                <button class="btn btn-danger" onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="number" id="statTrack">0</div>
                <div class="label">Track Photos</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statSoccer">0</div>
                <div class="label">Soccer Photos</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statFootball">0</div>
                <div class="label">Football Photos</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statBasketball">0</div>
                <div class="label">Basketball Photos</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statBestOf">0</div>
                <div class="label">Best Of Photos</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="admin-content">
            <!-- Sidebar -->
            <aside class="admin-sidebar">
                <ul class="sidebar-menu">
                    <li><a onclick="showPanel('overview', event)" class="active">üìä Overview</a></li>
                    <li><a onclick="showPanel('upload', event)">‚¨ÜÔ∏è Upload Photos</a></li>
                    <li><a onclick="showPanel('googledrive', event)">‚òÅÔ∏è Google Drive</a></li>
                    <li><a onclick="showPanel('manage', event)">üñºÔ∏è Manage Photos</a></li>
                    <li><a onclick="showPanel('config', event)">‚öôÔ∏è Configuration</a></li>
                    <li><a onclick="showPanel('help', event)">‚ùì Help</a></li>
                </ul>
            </aside>

            <!-- Panels -->
            <main class="admin-main">
                <!-- Overview Panel -->
                <section id="panelOverview" class="panel-section active">
                    <h2>Welcome to Your Admin Panel</h2>
                    
                    <div class="instructions-box" style="background: rgba(0, 170, 0, 0.1); border-color: var(--success);">
                        <h3>üöÄ NEW: Deploy Directly from Browser!</h3>
                        <ol>
                            <li>Upload photos using the <strong>Upload Photos</strong> panel</li>
                            <li>Organize and preview your photos in the <strong>Manage Photos</strong> panel</li>
                            <li>Go to <strong>Configuration</strong> panel</li>
                            <li>Enter your GitHub token (one-time setup)</li>
                            <li>Click <strong>"DEPLOY TO GITHUB NOW"</strong></li>
                            <li>Done! Your photos are live in 1-2 minutes! üéâ</li>
                        </ol>
                        <p style="margin-top: 15px; padding: 15px; background: var(--white); border: 2px solid var(--success);">
                            <strong>‚ú® No more manual steps!</strong> Upload photos on the website and they automatically go live on GitHub!
                        </p>
                    </div>

                    <h3 style="font-family: Helvetica, Arial, sans-serif; font-size: 20px; margin: 30px 0 20px;">Quick Actions</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-blue" onclick="showPanel('upload')">‚¨ÜÔ∏è Upload New Photos</button>
                        <button class="btn" onclick="showPanel('manage')">üñºÔ∏è Browse Galleries</button>
                        <button class="btn btn-success" onclick="showPanel('config')">üöÄ Deploy to GitHub</button>
                    </div>

                    <h3 style="font-family: Helvetica, Arial, sans-serif; font-size: 20px; margin: 30px 0 20px;">Recent Activity</h3>
                    <div id="recentActivity" style="background: var(--light-gray); padding: 20px; border: 3px solid var(--black);">
                        <p style="color: var(--gray);">No recent activity. Start by uploading some photos!</p>
                    </div>
                </section>

                <!-- Upload Panel -->
                <section id="panelUpload" class="panel-section">
                    <h2>Upload Photos</h2>
                    
                    <div class="instructions-box">
                        <h3>üì§ How to Upload</h3>
                        <ol>
                            <li>Select a category below</li>
                            <li>Click the upload zone or drag & drop your photos</li>
                            <li>Photos will be stored locally for preview</li>
                            <li>Go to Configuration panel to get the code for deployment</li>
                        </ol>
                    </div>

                    <h3 style="font-family: Helvetica, Arial, sans-serif; margin-bottom: 15px;">Select Category</h3>
                    <div class="category-selector">
                        <button class="category-btn active" data-category="track" onclick="selectCategory('track', event)">üì∏ TRACK</button>
                        <button class="category-btn" data-category="soccer" onclick="selectCategory('soccer', event)">‚öΩ SOCCER</button>
                        <button class="category-btn" data-category="football" onclick="selectCategory('football', event)">üèà FOOTBALL</button>
                        <button class="category-btn" data-category="basketball" onclick="selectCategory('basketball', event)">üèÄ BASKETBALL</button>
                        <button class="category-btn" data-category="bestOf" onclick="selectCategory('bestOf', event)">‚≠ê BEST OF</button>
                    </div>

                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <div class="icon">üìÅ</div>
                        <h3>Click to Upload or Drag & Drop</h3>
                        <p>Supports: JPG, JPEG, PNG, GIF</p>
                    </div>
                    <input type="file" id="fileInput" multiple accept="image/*">

                    <div id="previewGrid" class="photo-grid"></div>
                </section>

                <!-- Google Drive Panel -->
                <section id="panelGoogledrive" class="panel-section">
                    <h2>Import from Google Drive</h2>
                    
                    <div class="instructions-box" style="background: rgba(0, 204, 102, 0.15); border: 3px solid #00cc66;">
                        <h3>‚ú® 100% FREE - No Credit Card Required!</h3>
                        <p style="font-size: 16px; margin-bottom: 15px;">
                            <strong>NEW:</strong> This feature now works without any Google Cloud account or credit card!
                        </p>
                        <h3>‚òÅÔ∏è How to Import from Google Drive</h3>
                        <ol>
                            <li>Create a folder in Google Drive and add your images</li>
                            <li>Right-click the folder ‚Üí "Share" ‚Üí "Get link"</li>
                            <li>Change to <strong>"Anyone with the link"</strong> can VIEW</li>
                            <li>Click "Done" and copy the folder link</li>
                            <li>Paste the link below and select a category</li>
                            <li>Click "Import Images" - Done! GitHub Actions will automatically download and add them</li>
                        </ol>
                        <p style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 2px solid #ffc107;">
                            <strong>‚ö†Ô∏è Security Note:</strong> This method requires making your folder publicly accessible. <strong>Only use this feature for images you intend to publish on your public portfolio website.</strong> Never share folders containing private, sensitive, or personal information that you don't want to be publicly accessible.
                        </p>
                        <p style="margin-top: 15px; padding: 15px; background: var(--white); border: 2px solid #00cc66;">
                            <strong>‚ú® Automatic & Free:</strong> This triggers a GitHub Actions workflow that downloads images from your public Google Drive folder and commits them to your repository. The process takes 2-5 minutes depending on the number of images. No service accounts, no credentials, no cost!
                        </p>
                    </div>

                    <div style="background: var(--white); padding: 20px; border: 2px solid var(--black); margin-bottom: 20px;">
                        <h3 style="font-family: Helvetica, Arial, sans-serif; margin-bottom: 15px;">Google Drive Folder Link</h3>
                        <input type="text" id="driveFolderLink" placeholder="https://drive.google.com/drive/folders/..." 
                               style="width: 100%; padding: 15px; border: 3px solid var(--black); font-family: Helvetica, Arial, sans-serif; font-size: 14px; margin-bottom: 15px;">
                        
                        <h3 style="font-family: Helvetica, Arial, sans-serif; margin: 20px 0 15px;">Select Category</h3>
                        <div class="category-selector" style="margin-bottom: 20px;">
                            <button class="category-btn active" data-category="track" onclick="selectDriveCategory('track', event)">üì∏ TRACK</button>
                            <button class="category-btn" data-category="soccer" onclick="selectDriveCategory('soccer', event)">‚öΩ SOCCER</button>
                            <button class="category-btn" data-category="football" onclick="selectDriveCategory('football', event)">üèà FOOTBALL</button>
                            <button class="category-btn" data-category="basketball" onclick="selectDriveCategory('basketball', event)">üèÄ BASKETBALL</button>
                            <button class="category-btn" data-category="best-of" onclick="selectDriveCategory('best-of', event)">‚≠ê BEST OF</button>
                        </div>
                        
                        <button class="btn btn-success" onclick="importFromGoogleDrive()" style="font-size: 16px; padding: 15px 30px; width: 100%;">
                            ‚òÅÔ∏è IMPORT IMAGES FROM GOOGLE DRIVE
                        </button>
                    </div>
                    
                    <div id="driveImportStatus" style="display: none; padding: 20px; border: 3px solid var(--black); margin-bottom: 20px;"></div>
                    
                    <div class="instructions-box" style="background: rgba(0, 204, 102, 0.1); border: 2px solid #00cc66;">
                        <h3>‚úÖ Setup (Quick & Easy - 2 Minutes!)</h3>
                        <p style="margin-bottom: 10px;"><strong>To use this FREE feature:</strong></p>
                        <ol>
                            <li><strong>Share your folder publicly</strong> (Right-click ‚Üí Share ‚Üí "Anyone with the link" can view)</li>
                            <li>That's it! No credit card, no Google Cloud account needed!</li>
                        </ol>
                        <p style="margin-top: 15px; padding: 15px; background: var(--white); border: 2px solid #00cc66;">
                            <strong>üìñ More Details?</strong> See the complete guide in <code>GOOGLE_DRIVE_SETUP.md</code> in the repository.
                        </p>
                    </div>
                </section>

                <!-- Manage Panel -->
                <section id="panelManage" class="panel-section">
                    <h2>Manage Photos</h2>
                    
                    <div class="instructions-box" style="margin-bottom: 20px;">
                        <h3>üìã Photo Ordering</h3>
                        <p style="line-height: 1.6;">
                            <strong>The first photo (#1 üåü) will be the title/featured photo on the gallery page.</strong><br>
                            ‚Ä¢ <strong>Drag and drop</strong> photos to reorder them<br>
                            ‚Ä¢ Use <strong>‚¨ÜÔ∏è Up / ‚¨áÔ∏è Down</strong> buttons for precise positioning<br>
                            ‚Ä¢ Changes are saved automatically and reflected in the configuration
                        </p>
                    </div>
                    
                    <h3 style="font-family: Helvetica, Arial, sans-serif; margin-bottom: 15px;">Select Gallery</h3>
                    <div class="category-selector">
                        <button class="category-btn active" data-gallery="track" onclick="showGallery('track')">üì∏ TRACK</button>
                        <button class="category-btn" data-gallery="soccer" onclick="showGallery('soccer')">‚öΩ SOCCER</button>
                        <button class="category-btn" data-gallery="football" onclick="showGallery('football')">üèà FOOTBALL</button>
                        <button class="category-btn" data-gallery="basketball" onclick="showGallery('basketball')">üèÄ BASKETBALL</button>
                        <button class="category-btn" data-gallery="bestOf" onclick="showGallery('bestOf')">‚≠ê BEST OF</button>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <button class="btn btn-blue" onclick="downloadAllCategoryPhotos()">üíæ Download All Photos in This Category</button>
                        <p style="margin-top: 10px; color: var(--gray); font-size: 14px;">
                            Download all photos from the currently selected category. You can also download individual photos by hovering over them.
                        </p>
                    </div>

                    <div id="galleryGrid" class="photo-grid"></div>
                </section>

                <!-- Config Panel -->
                <section id="panelConfig" class="panel-section">
                    <h2>Configuration</h2>
                    
                    <div class="instructions-box">
                        <h3>üìù Deployment Instructions</h3>
                        <ol>
                            <li>Copy the configuration code below</li>
                            <li>Open <code>js/config.js</code> in your code editor</li>
                            <li>Replace the entire content with this code</li>
                            <li>Save the file</li>
                            <li>Commit and push to GitHub: <code>git add . && git commit -m "Update photos" && git push</code></li>
                            <li>Wait 1-2 minutes for GitHub Pages to deploy</li>
                        </ol>
                    </div>

                    <div class="config-editor">
                        <label style="font-family: Helvetica, Arial, sans-serif; font-weight: 700; display: block; margin-bottom: 10px;">
                            CONFIGURATION CODE (Copy this to js/config.js)
                        </label>
                        <textarea id="configCode" readonly></textarea>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="copyConfig()">üìã Copy to Clipboard</button>
                        <button class="btn" onclick="downloadConfig()">üíæ Download Config File</button>
                        <button class="btn btn-blue" onclick="downloadPhotosPackage()">üì¶ Download Photos Package</button>
                    </div>
                    
                    <div class="instructions-box" style="margin-top: 30px; background: rgba(0, 170, 0, 0.1); border-color: var(--success);">
                        <h3>üöÄ NEW: Deploy Directly to GitHub!</h3>
                        <p style="margin-bottom: 15px;">Skip the manual steps - deploy your photos directly from the browser!</p>
                        
                        <div style="background: var(--white); padding: 20px; border: 2px solid var(--black); margin-bottom: 20px;">
                            <label style="font-family: Helvetica, Arial, sans-serif; font-weight: 700; display: block; margin-bottom: 10px;">
                                GitHub Personal Access Token:
                            </label>
                            <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" 
                                   style="width: 100%; padding: 10px; border: 3px solid var(--black); font-family: Helvetica, Arial, sans-serif; font-size: 14px; margin-bottom: 10px;">
                            <p style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">
                                Your token is stored only in your browser and never sent to any third-party servers.
                            </p>
                            <p style="font-size: 11px; color: var(--danger); margin-bottom: 10px;">
                                ‚ö†Ô∏è <strong>Security:</strong> Tokens in localStorage can be accessed by browser extensions. Only use on trusted devices. Use a token with minimal permissions (repo access only).
                            </p>
                            <button class="btn" onclick="saveGitHubToken()" style="font-size: 12px; padding: 8px 16px;">üíæ Save Token</button>
                            <button class="btn" onclick="showTokenInstructions()" style="font-size: 12px; padding: 8px 16px;">‚ùì How to get a token?</button>
                        </div>

                        <button class="btn btn-success" onclick="deployDirectlyToGitHub()" style="font-size: 16px; padding: 15px 30px;">
                            üöÄ DEPLOY TO GITHUB NOW
                        </button>
                        
                        <div id="deployStatus" style="margin-top: 15px; padding: 15px; display: none; border: 3px solid var(--black);"></div>
                    </div>
                    
                    <div class="instructions-box" style="margin-top: 30px;">
                        <h3>üì¶ Download Photos Package (Alternative Method)</h3>
                        <p style="margin-bottom: 10px;">If you prefer to deploy manually, click "Download Photos Package" to get a ZIP file containing:</p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>All photos organized in their category folders (track, soccer, football, basketball, best-of)</li>
                            <li>Updated <code>config.js</code> file</li>
                            <li>README with deployment instructions</li>
                        </ul>
                        <p style="margin-top: 15px;"><strong>To deploy:</strong> Extract the ZIP, copy files to your repository, commit and push!</p>
                    </div>
                </section>

                <!-- Help Panel -->
                <section id="panelHelp" class="panel-section">
                    <h2>Help & Documentation</h2>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="font-family: Helvetica, Arial, sans-serif; font-size: 20px; margin-bottom: 15px;">üìñ Getting Started</h3>
                        <p style="line-height: 1.8; margin-bottom: 15px;">
                            This admin panel allows you to manage your photography portfolio locally. You can upload photos, organize them into categories, and generate the configuration code needed to deploy your changes to the live website.
                        </p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="font-family: Helvetica, Arial, sans-serif; font-size: 20px; margin-bottom: 15px;">üîí Security</h3>
                        <p style="line-height: 1.8; margin-bottom: 15px;">
                            Your PIN is stored locally in your browser. Default PIN is <code style="background: var(--light-gray); padding: 3px 8px; border: 1px solid var(--black);">1234</code>. To change it, update the <code style="background: var(--light-gray); padding: 3px 8px; border: 1px solid var(--black);">ADMIN_PIN</code> variable in the admin.html file.
                        </p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="font-family: Helvetica, Arial, sans-serif; font-size: 20px; margin-bottom: 15px;">üíæ Data Storage</h3>
                        <p style="line-height: 1.8; margin-bottom: 15px;">
                            Photos are stored in your browser's localStorage as base64 encoded data. This means:
                        </p>
                        <ul style="margin-left: 30px; line-height: 1.8;">
                            <li>Photos persist across page reloads</li>
                            <li>Photos are only visible on this browser</li>
                            <li>Storage is limited (usually 5-10MB)</li>
                            <li>Clearing browser data will delete your uploads</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="font-family: Helvetica, Arial, sans-serif; font-size: 20px; margin-bottom: 15px;">üöÄ Publishing Changes</h3>
                        <p style="line-height: 1.8; margin-bottom: 15px;">
                            <strong>NEW: Easy one-click deployment!</strong>
                        </p>
                        <ol style="margin-left: 30px; line-height: 1.8;">
                            <li>Go to the Configuration panel</li>
                            <li>Click <strong>"Download Photos Package"</strong> button</li>
                            <li>Extract the downloaded ZIP file</li>
                            <li>Copy the <code style="background: var(--light-gray); padding: 3px 8px; border: 1px solid var(--black);">images/</code> and <code style="background: var(--light-gray); padding: 3px 8px; border: 1px solid var(--black);">js/</code> folders to your repository (replace when prompted)</li>
                            <li>Commit and push to GitHub: <code style="background: var(--light-gray); padding: 3px 8px; border: 1px solid var(--black);">git add . && git commit -m "Update photos" && git push</code></li>
                            <li>Wait 1-2 minutes for GitHub Pages to deploy</li>
                        </ol>
                        <p style="margin-top: 15px; padding: 15px; background: rgba(0, 170, 0, 0.1); border: 2px solid var(--success);">
                            <strong>üí° New Feature:</strong> The Photos Package includes all your photos AND the updated config file. No manual code editing required!
                        </p>
                    </div>

                    <div style="background: var(--light-gray); padding: 25px; border: 3px solid var(--black);">
                        <h3 style="font-family: Helvetica, Arial, sans-serif; font-size: 20px; margin-bottom: 15px;">üìß Need Help?</h3>
                        <p style="line-height: 1.8;">
                            For technical support or questions, refer to the README.md file in the repository or contact your web developer.
                        </p>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- JSZip for creating ZIP files (loaded from CDN with integrity check) -->
    <!-- Using JSZip v3.10.1 (latest stable as of Jan 2024) for ZIP file creation -->
    <!-- SRI hash ensures the script hasn't been tampered with -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" 
            integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" 
            crossorigin="anonymous"></script>
    <!-- Fallback notice will be shown in the downloadPhotosPackage function if JSZip fails to load -->
    
    <script src="js/config.js"></script>
    <script>
        // Admin PIN (change this to your desired PIN)
        // ‚ö†Ô∏è IMPORTANT SECURITY WARNING:
        // This is CLIENT-SIDE authentication only and provides basic access control.
        // Anyone with access to the source code can see or bypass this PIN.
        // The default PIN '1234' MUST be changed before deploying to production.
        // For production use with sensitive data, implement server-side authentication.
        const ADMIN_PIN = '1234';
        
        // Image compression settings
        const IMAGE_MAX_WIDTH = 2000;  // Maximum width for uploaded images
        const IMAGE_QUALITY = 0.85;     // JPEG quality (0-1, where 1 is highest quality)
        const BASE64_OVERHEAD = 0.75;   // Base64 encoding efficiency factor (actual data is ~75% of encoded string)
        const RETRY_BASE_DELAY_MS = 500; // Base delay for exponential backoff (500ms, 1000ms, 2000ms...)
        
        // Current selected category for upload
        let currentCategory = 'track';
        let currentGallery = 'track';
        let photoIdCounter = 0; // Counter to ensure unique photo IDs

        // ========== IndexedDB Photo Storage ==========
        
        const DB_NAME = 'AdminPhotoDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'photos';
        let db = null;

        // Initialize IndexedDB
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('IndexedDB error:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('IndexedDB initialized successfully');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create object store if it doesn't exist
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        objectStore.createIndex('category', 'category', { unique: false });
                        objectStore.createIndex('filename', 'filename', { unique: false });
                        console.log('IndexedDB object store created');
                    }
                };
            });
        }

        // Save photo blob to IndexedDB
        async function saveBlobToIndexedDB(id, category, filename, blob, timestamp) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                
                const data = {
                    id: id,
                    category: category,
                    filename: filename,
                    blob: blob,
                    timestamp: timestamp
                };
                
                const request = objectStore.put(data);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Get photo blob from IndexedDB
        async function getBlobFromIndexedDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.get(id);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Get all photos for a category from IndexedDB
        async function getBlobsForCategory(category) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const index = objectStore.index('category');
                const request = index.getAll(category);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Delete photo blob from IndexedDB
        async function deleteBlobFromIndexedDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Convert dataURL to Blob
        function dataURLToBlob(dataURL) {
            const parts = dataURL.split(',');
            const mime = parts[0].match(/:(.*?);/)[1];
            const base64 = parts[1];
            const binary = atob(base64);
            const array = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                array[i] = binary.charCodeAt(i);
            }
            return new Blob([array], { type: mime });
        }

        // Convert Blob to dataURL
        async function blobToDataURL(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Migrate existing localStorage photos to IndexedDB
        async function migrateToIndexedDB() {
            try {
                const oldPhotos = JSON.parse(localStorage.getItem('adminPhotos') || '{}');
                
                // Check if migration is needed
                let needsMigration = false;
                for (const category in oldPhotos) {
                    if (oldPhotos[category] && oldPhotos[category].length > 0) {
                        // Check if any photo has dataUrl (old format)
                        if (oldPhotos[category].some(p => p.dataUrl)) {
                            needsMigration = true;
                            break;
                        }
                    }
                }
                
                if (!needsMigration) {
                    console.log('No migration needed - already using IndexedDB format');
                    return;
                }
                
                console.log('Migrating photos from localStorage to IndexedDB...');
                showNotification('‚è≥ Migrating photos to new storage format...', 'success');
                
                const newMetadata = {};
                let migratedCount = 0;
                
                for (const category in oldPhotos) {
                    if (!oldPhotos[category] || oldPhotos[category].length === 0) continue;
                    
                    newMetadata[category] = [];
                    
                    for (const photo of oldPhotos[category]) {
                        if (!photo.dataUrl) continue; // Skip if already migrated
                        
                        try {
                            // Convert dataURL to blob
                            const blob = dataURLToBlob(photo.dataUrl);
                            
                            // Generate unique ID
                            const id = `${category}_${photo.filename}_${photo.timestamp || Date.now()}`;
                            
                            // Save blob to IndexedDB
                            await saveBlobToIndexedDB(id, category, photo.filename, blob, photo.timestamp || Date.now());
                            
                            // Save metadata to new structure (without dataUrl)
                            newMetadata[category].push({
                                id: id,
                                filename: photo.filename,
                                timestamp: photo.timestamp || Date.now()
                            });
                            
                            migratedCount++;
                        } catch (error) {
                            console.error(`Error migrating photo ${photo.filename}:`, error);
                        }
                    }
                }
                
                // Save new metadata structure to localStorage
                localStorage.setItem('adminPhotosMetadata', JSON.stringify(newMetadata));
                
                // Remove old large localStorage key
                localStorage.removeItem('adminPhotos');
                
                console.log(`Migration complete! Migrated ${migratedCount} photos to IndexedDB`);
                showNotification(`‚úì Migrated ${migratedCount} photos to new storage format!`, 'success');
                
            } catch (error) {
                console.error('Migration error:', error);
                showNotification('‚ö†Ô∏è Migration had some errors. Check console for details.', 'error');
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            initPinAuth();
            
            // Initialize IndexedDB first
            try {
                await initIndexedDB();
                // Migrate existing data if needed
                await migrateToIndexedDB();
                // Load photos (now from new storage)
                loadPhotosFromStorage();
                updateStats();
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('‚ö†Ô∏è Error initializing storage. Some features may not work.', 'error');
            }
            
            loadSavedGitHubToken();
        });

        // Load saved GitHub token into the field
        function loadSavedGitHubToken() {
            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
            }
        }

        // PIN Authentication
        function initPinAuth() {
            const pinInputs = document.querySelectorAll('.pin-digit');
            
            pinInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1 && index < pinInputs.length - 1) {
                        pinInputs[index + 1].focus();
                    }
                    
                    // Check if all digits are filled
                    if (index === pinInputs.length - 1 && e.target.value.length === 1) {
                        checkPin();
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                        pinInputs[index - 1].focus();
                    }
                });
            });
        }

        function checkPin() {
            const pinInputs = document.querySelectorAll('.pin-digit');
            const enteredPin = Array.from(pinInputs).map(input => input.value).join('');
            
            if (enteredPin === ADMIN_PIN) {
                // Correct PIN
                document.getElementById('pinModal').classList.add('hidden');
                document.getElementById('adminContainer').classList.add('active');
                showNotification('‚úì Access granted! Welcome to the admin panel.', 'success');
            } else {
                // Wrong PIN
                document.getElementById('pinError').classList.add('show');
                pinInputs.forEach(input => {
                    input.value = '';
                    input.style.borderColor = 'var(--danger)';
                });
                pinInputs[0].focus();
                
                setTimeout(() => {
                    document.getElementById('pinError').classList.remove('show');
                    pinInputs.forEach(input => {
                        input.style.borderColor = 'var(--black)';
                    });
                }, 2000);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                document.getElementById('adminContainer').classList.remove('active');
                document.getElementById('pinModal').classList.remove('hidden');
                // Clear PIN inputs
                document.querySelectorAll('.pin-digit').forEach(input => {
                    input.value = '';
                });
                document.getElementById('pin1').focus();
            }
        }

        // Panel Navigation
        function showPanel(panelName, clickEvent) {
            // Hide all panels
            document.querySelectorAll('.panel-section').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Show selected panel
            document.getElementById('panel' + panelName.charAt(0).toUpperCase() + panelName.slice(1)).classList.add('active');
            
            // Update sidebar active state
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            if (clickEvent && clickEvent.target) {
                clickEvent.target.classList.add('active');
            }

            // Refresh data for specific panels
            if (panelName === 'manage') {
                showGallery(currentGallery);
            } else if (panelName === 'config') {
                generateConfig();
            }
        }

        // Category Selection
        function selectCategory(category, clickEvent) {
            currentCategory = category;
            document.querySelectorAll('.category-btn[data-category]').forEach(btn => {
                btn.classList.remove('active');
            });
            if (clickEvent && clickEvent.target) {
                clickEvent.target.classList.add('active');
            }
        }

        // Google Drive Category Selection
        let selectedDriveCategory = 'track';
        function selectDriveCategory(category, clickEvent) {
            selectedDriveCategory = category;
            // Get all category buttons in the Google Drive panel only
            const drivePanel = document.getElementById('panelGoogledrive');
            const buttons = drivePanel.querySelectorAll('.category-btn[data-category]');
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });
            if (clickEvent && clickEvent.target) {
                clickEvent.target.classList.add('active');
            }
        }

        // Import from Google Drive
        async function importFromGoogleDrive() {
            const folderLink = document.getElementById('driveFolderLink').value.trim();
            const statusDiv = document.getElementById('driveImportStatus');
            
            if (!folderLink) {
                showNotification('Please enter a Google Drive folder link', 'error');
                return;
            }
            
            // Validate input format - match backend validation
            if (!/^[a-zA-Z0-9_/:.?=-]+$/.test(folderLink)) {
                showNotification('Invalid characters in folder link', 'error');
                return;
            }
            
            // Validate folder link format
            const hasFolderPattern = /\/folders\/([a-zA-Z0-9_-]+)/.test(folderLink);
            const hasUserFolderPattern = /\/u\/[0-9]+\/folders\/([a-zA-Z0-9_-]+)/.test(folderLink);
            const isDirectId = /^[a-zA-Z0-9_-]+$/.test(folderLink);
            
            if (!hasFolderPattern && !hasUserFolderPattern && !isDirectId) {
                showNotification('Invalid Google Drive folder link format. Expected URL like: https://drive.google.com/drive/folders/FOLDER_ID', 'error');
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'rgba(0, 102, 204, 0.1)';
            statusDiv.style.borderColor = 'var(--blue)';
            statusDiv.innerHTML = '‚è≥ Triggering GitHub Actions workflow...';
            
            try {
                // Get GitHub token from localStorage
                const token = localStorage.getItem('githubToken');
                if (!token) {
                    throw new Error('GitHub token not found. Please configure it in the Configuration panel.');
                }
                
                // GitHub repository details
                const GITHUB_OWNER = 'CooperHofmann';
                const GITHUB_REPO = 'cooperofthecrop.github.io';
                
                // Trigger repository_dispatch event
                const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: 'sync-google-drive-images',
                        client_payload: {
                            folder_link: folderLink,
                            category: selectedDriveCategory
                        }
                    })
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('GitHub Actions workflow not found. Make sure the workflow file exists in .github/workflows/');
                    } else if (response.status === 401) {
                        throw new Error('Invalid GitHub token. Please update your token in the Configuration panel.');
                    } else {
                        throw new Error(`GitHub API error: ${response.status}`);
                    }
                }
                
                statusDiv.style.background = 'rgba(0, 170, 0, 0.1)';
                statusDiv.style.borderColor = 'var(--success)';
                statusDiv.innerHTML = `
                    <h3 style="font-family: Helvetica, Arial, sans-serif; margin-bottom: 10px;">‚úÖ Workflow Triggered Successfully!</h3>
                    <p style="margin-bottom: 10px;">GitHub Actions is now downloading images from Google Drive and adding them to the <strong>${selectedDriveCategory}</strong> category.</p>
                    <p style="margin-bottom: 10px;"><strong>Next Steps:</strong></p>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>Go to <a href="https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/actions" target="_blank" style="color: var(--blue); text-decoration: underline;">GitHub Actions</a> to monitor progress</li>
                        <li>The workflow typically takes 2-5 minutes to complete</li>
                        <li>Once complete, refresh your website to see the new images</li>
                        <li>Images will appear in the <strong>${selectedDriveCategory}</strong> gallery</li>
                    </ol>
                    <p style="margin-top: 15px; padding: 10px; background: var(--white); border: 2px solid var(--success);">
                        <strong>üí° Tip:</strong> You can trigger multiple imports. Each will be processed in order.
                    </p>
                `;
                
                showNotification('Google Drive import started! Check GitHub Actions for progress.', 'success');
                
                // Clear the input
                document.getElementById('driveFolderLink').value = '';
                
            } catch (error) {
                console.error('Error triggering workflow:', error);
                statusDiv.style.background = 'rgba(204, 0, 0, 0.1)';
                statusDiv.style.borderColor = 'var(--danger)';
                statusDiv.innerHTML = `
                    <h3 style="font-family: Helvetica, Arial, sans-serif; margin-bottom: 10px;">‚ùå Error</h3>
                    <p style="margin-bottom: 10px;"><strong>${error.message}</strong></p>
                    <p style="margin-bottom: 10px;">Common issues:</p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>GitHub token not configured or expired (go to Configuration panel)</li>
                        <li>Google Drive folder not shared publicly (Right-click folder ‚Üí Share ‚Üí "Anyone with the link")</li>
                        <li>GitHub Actions workflow file missing (.github/workflows/google-drive-sync.yml)</li>
                        <li>Invalid folder link format</li>
                    </ul>
                `;
                showNotification(error.message, 'error');
            }
        }

        // File Upload
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        const uploadZone = document.getElementById('uploadZone');
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFileSelect({ target: { files: e.dataTransfer.files } });
        });

        // Image Compression Function
        async function compressImage(file, maxWidth = IMAGE_MAX_WIDTH, quality = IMAGE_QUALITY) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        try {
                            // Create canvas for compression
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            // Validate image dimensions
                            if (width <= 0 || height <= 0) {
                                reject(new Error('Invalid image dimensions'));
                                return;
                            }
                            
                            // Scale down if image is too large
                            if (width > maxWidth) {
                                height = Math.floor((height * maxWidth) / width);
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            if (!ctx) {
                                reject(new Error('Failed to get canvas context'));
                                return;
                            }
                            
                            // Enable image smoothing for better quality
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            
                            // Draw image on canvas
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Determine output format based on input file type
                            // Use original format for PNG/GIF to preserve transparency, otherwise use JPEG
                            const outputFormat = (file.type === 'image/png' || file.type === 'image/gif') 
                                ? file.type 
                                : 'image/jpeg';
                            const outputQuality = (outputFormat === 'image/jpeg') ? quality : 0.95;
                            
                            // Convert to blob with timeout protection
                            let timeoutId = setTimeout(() => {
                                reject(new Error('Canvas toBlob timeout'));
                            }, 15000); // 15 second timeout for better responsiveness
                            
                            canvas.toBlob((blob) => {
                                clearTimeout(timeoutId);
                                
                                if (!blob) {
                                    reject(new Error('Failed to create blob from canvas'));
                                    return;
                                }
                                
                                const compressedReader = new FileReader();
                                compressedReader.onload = (event) => {
                                    resolve(event.target.result);
                                };
                                compressedReader.onerror = (err) => {
                                    reject(new Error('Failed to read compressed image: ' + err));
                                };
                                compressedReader.readAsDataURL(blob);
                            }, outputFormat, outputQuality);
                            
                        } catch (error) {
                            reject(new Error('Canvas processing error: ' + error.message));
                        }
                    };
                    
                    img.onerror = (err) => {
                        reject(new Error('Failed to load image: ' + (err.message || 'Unknown error')));
                    };
                    
                    // Set crossOrigin before setting src
                    img.crossOrigin = 'anonymous';
                    img.src = e.target.result;
                };
                
                reader.onerror = (err) => {
                    reject(new Error('Failed to read file: ' + (err.message || 'Unknown error')));
                };
                
                reader.readAsDataURL(file);
            });
        }

        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            const MAX_RETRIES = 2;
            
            for (const file of files) {
                if (!file.type.match('image.*')) {
                    showNotification('‚ùå Please upload only image files', 'error');
                    continue;
                }
                
                // Validate file size (warn if > 10MB)
                const fileSizeMB = file.size / (1024 * 1024);
                if (fileSizeMB > 10) {
                    showNotification(`‚ö†Ô∏è ${file.name} is large (${fileSizeMB.toFixed(1)}MB). Processing may take a moment...`, 'warning');
                }

                let success = false;
                let lastError = null;
                
                // Retry logic for reliability
                for (let attempt = 0; attempt <= MAX_RETRIES && !success; attempt++) {
                    try {
                        if (attempt > 0) {
                            console.log(`Retrying compression for ${file.name} (attempt ${attempt + 1}/${MAX_RETRIES + 1})`);
                        }
                        
                        // Compress the image before saving
                        const compressedDataUrl = await compressImage(file, IMAGE_MAX_WIDTH, IMAGE_QUALITY);
                        
                        // Validate the compressed result
                        if (!compressedDataUrl || !compressedDataUrl.startsWith('data:image/')) {
                            throw new Error('Invalid compressed image data');
                        }
                        
                        // Calculate compression ratio
                        const originalSize = file.size / 1024; // Original size in KB
                        // Remove data URL prefix to get just the Base64 data
                        const base64Data = compressedDataUrl.split(',')[1];
                        // Base64 encoding: each character represents 6 bits but takes 8 bits to store
                        // So actual binary data size = base64Length * 0.75
                        const compressedSize = (base64Data.length * BASE64_OVERHEAD / 1024);
                        const compressionRatio = Math.max(0, Math.round((1 - compressedSize / originalSize) * 100));
                        
                        await savePhoto(currentCategory, file.name, compressedDataUrl);
                        
                        if (compressionRatio > 0) {
                            showNotification(`‚úì ${file.name} compressed (${compressionRatio}% smaller) and uploaded to ${currentCategory}!`, 'success');
                        } else {
                            showNotification(`‚úì ${file.name} uploaded to ${currentCategory}!`, 'success');
                        }
                        updateStats();
                        success = true;
                        
                    } catch (error) {
                        lastError = error;
                        console.error(`Compression error for ${file.name} (attempt ${attempt + 1}):`, error);
                        
                        // Wait before retry (exponential backoff: 500ms, 1000ms, 2000ms...)
                        if (attempt < MAX_RETRIES) {
                            await new Promise(resolve => setTimeout(resolve, RETRY_BASE_DELAY_MS * Math.pow(2, attempt)));
                        }
                    }
                }
                
                // If all retries failed, show error
                if (!success) {
                    const errorMsg = lastError?.message || 'Unknown error';
                    showNotification(`‚ùå Failed to process ${file.name}: ${errorMsg}`, 'error');
                    console.error('All compression attempts failed for', file.name, lastError);
                }
            }

            // Clear input
            e.target.value = '';
        }

        // Photo Storage (IndexedDB + localStorage metadata)
        async function savePhoto(category, filename, dataUrl) {
            try {
                // Convert dataURL to blob
                const blob = dataURLToBlob(dataUrl);
                
                // Generate unique ID
                const timestamp = Date.now();
                const id = `${category}_${filename}_${timestamp}`;
                
                // Save blob to IndexedDB
                await saveBlobToIndexedDB(id, category, filename, blob, timestamp);
                
                // Get current metadata
                const metadata = JSON.parse(localStorage.getItem('adminPhotosMetadata') || '{}');
                if (!metadata[category]) {
                    metadata[category] = [];
                }
                
                // Check if photo already exists
                const existingIndex = metadata[category].findIndex(p => p.filename === filename);
                if (existingIndex >= 0) {
                    // Delete old blob from IndexedDB
                    const oldId = metadata[category][existingIndex].id;
                    await deleteBlobFromIndexedDB(oldId);
                    
                    // Update metadata
                    metadata[category][existingIndex] = { id, filename, timestamp };
                } else {
                    // Add new metadata entry
                    metadata[category].push({ id, filename, timestamp });
                }
                
                // Save metadata to localStorage
                localStorage.setItem('adminPhotosMetadata', JSON.stringify(metadata));
                
            } catch (error) {
                console.error('Error saving photo:', error);
                throw error;
            }
        }

        function loadPhotosFromStorage() {
            // Initialize if not exists
            if (!localStorage.getItem('adminPhotosMetadata')) {
                localStorage.setItem('adminPhotosMetadata', JSON.stringify({}));
            }
        }

        async function getPhotos(category) {
            try {
                // Get metadata from localStorage
                const metadata = JSON.parse(localStorage.getItem('adminPhotosMetadata') || '{}');
                const categoryMetadata = metadata[category] || [];
                
                // Get blobs from IndexedDB and combine with metadata
                const photos = [];
                for (const meta of categoryMetadata) {
                    try {
                        const photoData = await getBlobFromIndexedDB(meta.id);
                        if (photoData && photoData.blob) {
                            // Convert blob to dataURL for display
                            const dataUrl = await blobToDataURL(photoData.blob);
                            photos.push({
                                id: meta.id,
                                filename: meta.filename,
                                dataUrl: dataUrl,
                                timestamp: meta.timestamp
                            });
                        }
                    } catch (error) {
                        console.error(`Error loading photo ${meta.filename}:`, error);
                    }
                }
                
                return photos;
            } catch (error) {
                console.error('Error getting photos:', error);
                return [];
            }
        }

        async function deletePhoto(category, filename) {
            if (!confirm(`Delete ${filename} from ${category}?`)) return;
            
            try {
                // Get metadata
                const metadata = JSON.parse(localStorage.getItem('adminPhotosMetadata') || '{}');
                if (metadata[category]) {
                    // Find the photo to delete
                    const photoIndex = metadata[category].findIndex(p => p.filename === filename);
                    if (photoIndex >= 0) {
                        const photoId = metadata[category][photoIndex].id;
                        
                        // Delete blob from IndexedDB
                        await deleteBlobFromIndexedDB(photoId);
                        
                        // Remove from metadata
                        metadata[category] = metadata[category].filter(p => p.filename !== filename);
                        localStorage.setItem('adminPhotosMetadata', JSON.stringify(metadata));
                        
                        showGallery(category);
                        updateStats();
                        showNotification(`‚úì ${filename} deleted`, 'success');
                    }
                }
            } catch (error) {
                console.error('Error deleting photo:', error);
                showNotification('‚ùå Error deleting photo', 'error');
            }
        }

        // Gallery Management
        async function showGallery(gallery) {
            currentGallery = gallery;
            
            // Update button states
            document.querySelectorAll('.category-btn[data-gallery]').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.gallery === gallery) {
                    btn.classList.add('active');
                }
            });

            const photos = await getPhotos(gallery);
            const galleryGrid = document.getElementById('galleryGrid');
            
            if (photos.length === 0) {
                galleryGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: var(--gray);"><h3 style="font-family: Helvetica, Arial, sans-serif; font-size: 20px; margin-bottom: 10px;">No photos in this gallery yet</h3><p>Go to Upload panel to add photos</p></div>';
                return;
            }

            // Helper function to escape HTML
            const escapeHtml = (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };

            // Get home page photo settings
            const homePagePhotos = JSON.parse(localStorage.getItem('homePagePhotos') || '{}');
            const currentHomePagePhoto = homePagePhotos[gallery];

            galleryGrid.innerHTML = photos.map((photo, index) => {
                const safeFilename = escapeHtml(photo.filename);
                const safeGallery = escapeHtml(gallery);
                // Create a unique ID for each photo using timestamp + counter to prevent collisions
                const photoId = `photo_${safeGallery}_${Date.now()}_${++photoIdCounter}`;
                const isFirst = index === 0;
                const isLast = index === photos.length - 1;
                const isHomePagePhoto = currentHomePagePhoto === photo.filename;
                
                return `
                <div class="photo-item" draggable="true" data-index="${index}" data-filename="${safeFilename}">
                    <div class="order-badge">#${index + 1}${isFirst ? ' üåü' : ''}${isHomePagePhoto ? ' üè†' : ''}</div>
                    <img src="${photo.dataUrl}" alt="${safeFilename}" id="${photoId}">
                    <div class="overlay">
                        <div class="button-row">
                            <button onclick="movePhoto('${safeGallery}', ${index}, -1)" ${isFirst ? 'disabled style="opacity:0.3"' : ''}>‚¨ÜÔ∏è Up</button>
                            <button onclick="movePhoto('${safeGallery}', ${index}, 1)" ${isLast ? 'disabled style="opacity:0.3"' : ''}>‚¨áÔ∏è Down</button>
                        </div>
                        <div class="button-row">
                            <button onclick="setHomePagePhoto('${safeGallery}', '${safeFilename}')" ${isHomePagePhoto ? 'style="background:var(--success);color:var(--white)"' : ''}>üè† ${isHomePagePhoto ? 'Home Photo' : 'Set Home'}</button>
                        </div>
                        <div class="button-row">
                            <button onclick="downloadPhoto('${photoId}', '${safeFilename}')">üíæ Download</button>
                            <button onclick="deletePhoto('${safeGallery}', '${safeFilename}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            // Add drag and drop event listeners
            setupDragAndDrop(gallery);
        }
        
        // Move photo up or down in the order
        async function movePhoto(category, currentIndex, direction) {
            const metadata = JSON.parse(localStorage.getItem('adminPhotosMetadata') || '{}');
            if (!metadata[category] || metadata[category].length <= 1) return;
            
            const newIndex = currentIndex + direction;
            
            // Validate new index
            if (newIndex < 0 || newIndex >= metadata[category].length) return;
            
            // Swap photos in metadata
            const temp = metadata[category][currentIndex];
            metadata[category][currentIndex] = metadata[category][newIndex];
            metadata[category][newIndex] = temp;
            
            // Save and refresh
            localStorage.setItem('adminPhotosMetadata', JSON.stringify(metadata));
            await showGallery(category);
            updateConfigCode();
            showNotification('‚úì Photo order updated', 'success');
        }
        
        // Set photo as home page photo for a gallery
        function setHomePagePhoto(category, filename) {
            const homePagePhotos = JSON.parse(localStorage.getItem('homePagePhotos') || '{}');
            
            // Toggle: if already set, unset it; otherwise set it
            if (homePagePhotos[category] === filename) {
                delete homePagePhotos[category];
                showNotification(`‚úì Home page photo cleared for ${category}. Will use first photo.`, 'success');
            } else {
                homePagePhotos[category] = filename;
                showNotification(`‚úì ${filename} set as home page photo for ${category}!`, 'success');
            }
            
            localStorage.setItem('homePagePhotos', JSON.stringify(homePagePhotos));
            showGallery(category);
            updateConfigCode();
        }
        
        // Update config code in real-time
        function updateConfigCode() {
            if (document.getElementById('panelConfig').classList.contains('active')) {
                generateConfig();
            }
        }
        
        // Setup drag and drop functionality
        function setupDragAndDrop(gallery) {
            const photoItems = document.querySelectorAll('#galleryGrid .photo-item');
            let draggedElement = null;
            let draggedIndex = null;
            
            photoItems.forEach((item, index) => {
                // Drag start
                item.addEventListener('dragstart', (e) => {
                    draggedElement = item;
                    draggedIndex = parseInt(item.dataset.index, 10);
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                // Drag end
                item.addEventListener('dragend', (e) => {
                    item.classList.remove('dragging');
                    // Remove all drag-over classes
                    photoItems.forEach(i => i.classList.remove('drag-over'));
                });
                
                // Drag over
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    if (item !== draggedElement) {
                        item.classList.add('drag-over');
                    }
                });
                
                // Drag leave
                item.addEventListener('dragleave', (e) => {
                    item.classList.remove('drag-over');
                });
                
                // Drop
                item.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    
                    if (item !== draggedElement) {
                        const dropIndex = parseInt(item.dataset.index, 10);
                        
                        // Reorder photos in metadata storage
                        const metadata = JSON.parse(localStorage.getItem('adminPhotosMetadata') || '{}');
                        if (metadata[gallery]) {
                            const draggedPhoto = metadata[gallery][draggedIndex];
                            metadata[gallery].splice(draggedIndex, 1);
                            metadata[gallery].splice(dropIndex, 0, draggedPhoto);
                            
                            localStorage.setItem('adminPhotosMetadata', JSON.stringify(metadata));
                            await showGallery(gallery);
                            updateConfigCode();
                            showNotification('‚úì Photo order updated', 'success');
                        }
                    }
                });
            });
        }

        // Constants
        const DOWNLOAD_DELAY_MS = 200; // Delay between multiple file downloads to avoid browser blocking

        // Helper function to trigger file download
        function triggerDownload(dataUrl, filename) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            // Use setTimeout to ensure click event completes before removing
            setTimeout(() => {
                document.body.removeChild(a);
            }, 100);
        }

        // Download individual photo
        function downloadPhoto(photoId, filename) {
            const img = document.getElementById(photoId);
            if (!img) {
                showNotification('‚ùå Photo not found', 'error');
                return;
            }
            const dataUrl = img.src;
            triggerDownload(dataUrl, filename);
            showNotification(`‚úì ${filename} downloaded!`, 'success');
        }

        // Download all photos from current category
        async function downloadAllCategoryPhotos() {
            const photos = await getPhotos(currentGallery);
            if (photos.length === 0) {
                showNotification('‚ùå No photos in this category to download.', 'error');
                return;
            }

            showNotification(`üì• Downloading ${photos.length} photo${photos.length !== 1 ? 's' : ''}...`, 'success');
            
            // Download each photo with a slight delay to avoid browser blocking
            photos.forEach((photo, index) => {
                setTimeout(() => {
                    triggerDownload(photo.dataUrl, photo.filename);
                    
                    if (index === photos.length - 1) {
                        showNotification(`‚úì All ${photos.length} photo${photos.length !== 1 ? 's' : ''} downloaded!`, 'success');
                    }
                }, index * DOWNLOAD_DELAY_MS);
            });
        }

        // Stats Update
        function updateStats() {
            const metadata = JSON.parse(localStorage.getItem('adminPhotosMetadata') || '{}');
            
            document.getElementById('statTrack').textContent = (metadata.track || []).length;
            document.getElementById('statSoccer').textContent = (metadata.soccer || []).length;
            document.getElementById('statFootball').textContent = (metadata.football || []).length;
            document.getElementById('statBasketball').textContent = (metadata.basketball || []).length;
            document.getElementById('statBestOf').textContent = (metadata.bestOf || []).length;
        }

        // Configuration Generator
        function generateConfig() {
            const metadata = JSON.parse(localStorage.getItem('adminPhotosMetadata') || '{}');
            const homePagePhotos = JSON.parse(localStorage.getItem('homePagePhotos') || '{}');
            
            const configCode = `/**
 * IMAGE CONFIGURATION
 * 
 * This file controls which images appear in each portfolio section.
 * Generated by Admin Panel on ${new Date().toLocaleString()}
 */

const portfolioConfig = {
    track: {
        title: "TRACK &<br>FIELD",
        description: "Track & Field Photography",
        homePagePhoto: ${homePagePhotos.track ? `"${homePagePhotos.track}"` : 'null'}, // Set to filename to override, null uses first image
        images: [
${(metadata.track || []).map(p => `            "${p.filename}",`).join('\n')}
        ]
    },
    soccer: {
        title: "SOCCER",
        description: "Soccer Photography",
        homePagePhoto: ${homePagePhotos.soccer ? `"${homePagePhotos.soccer}"` : 'null'}, // Set to filename to override, null uses first image
        images: [
${(metadata.soccer || []).map(p => `            "${p.filename}",`).join('\n')}
        ]
    },
    football: {
        title: "FOOTBALL",
        description: "Football Photography",
        homePagePhoto: ${homePagePhotos.football ? `"${homePagePhotos.football}"` : 'null'}, // Set to filename to override, null uses first image
        images: [
${(metadata.football || []).map(p => `            "${p.filename}",`).join('\n')}
        ]
    },
    basketball: {
        title: "BASKETBALL",
        description: "Basketball Photography",
        homePagePhoto: ${homePagePhotos.basketball ? `"${homePagePhotos.basketball}"` : 'null'}, // Set to filename to override, null uses first image
        images: [
${(metadata.basketball || []).map(p => `            "${p.filename}",`).join('\n')}
        ]
    },
    bestOf: {
        title: "BEST<br>OF",
        description: "Curated Selection",
        homePagePhoto: ${homePagePhotos.bestOf ? `"${homePagePhotos.bestOf}"` : 'null'}, // Set to filename to override, null uses first image
        images: [
${(metadata.bestOf || []).map(p => `            "${p.filename}",`).join('\n')}
        ]
    }
};
};

// Placeholder images for empty galleries
const placeholderImages = [
    "https://images.unsplash.com/photo-1461896836934-ffe607ba8211?w=800&q=80",
    "https://images.unsplash.com/photo-1574629810360-7efbbe195018?w=800&q=80",
    "https://images.unsplash.com/photo-1566577134770-3d85bb3a9cc4?w=800&q=80",
    "https://images.unsplash.com/photo-1546519638-68e109498ffc?w=800&q=80",
];`;

            document.getElementById('configCode').value = configCode;
        }

        function copyConfig() {
            const configCode = document.getElementById('configCode').value;
            navigator.clipboard.writeText(configCode).then(() => {
                showNotification('‚úì Configuration copied to clipboard!', 'success');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.getElementById('configCode');
                textarea.select();
                try {
                    document.execCommand('copy');
                    showNotification('‚úì Configuration copied to clipboard!', 'success');
                } catch (e) {
                    showNotification('‚ùå Failed to copy. Please copy manually.', 'error');
                }
            });
        }

        function downloadConfig() {
            const configCode = document.getElementById('configCode').value;
            const blob = new Blob([configCode], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            triggerDownload(url, 'config.js');
            URL.revokeObjectURL(url);
            showNotification('‚úì Configuration downloaded!', 'success');
        }

        // Download Photos Package as ZIP
        async function downloadPhotosPackage() {
            const metadata = JSON.parse(localStorage.getItem('adminPhotosMetadata') || '{}');
            
            // Check if there are any photos
            const totalPhotos = Object.values(metadata).reduce((sum, arr) => sum + arr.length, 0);
            if (totalPhotos === 0) {
                showNotification('‚ùå No photos to download. Please upload some photos first.', 'error');
                return;
            }

            // Check if JSZip is available
            if (typeof JSZip === 'undefined') {
                // Fallback: Download files individually
                const proceed = confirm('JSZip library is not available. Would you like to download the config file and instructions instead?\n\n(Note: You will need to save photos manually from the Manage Photos section)');
                if (proceed) {
                    downloadConfig();
                    downloadDeploymentInstructions();
                    showNotification('‚ö†Ô∏è Config downloaded. Please save photos manually from Manage Photos section.', 'error');
                }
                return;
            }

            showNotification('üì¶ Creating package... This may take a moment.', 'success');

            try {
                const zip = new JSZip();
                
                // Add photos to appropriate folders
                const categories = {
                    track: 'track',
                    soccer: 'soccer',
                    football: 'football',
                    basketball: 'basketball',
                    bestOf: 'best-of'
                };

                for (const [category, folderName] of Object.entries(categories)) {
                    const categoryMetadata = metadata[category] || [];
                    if (categoryMetadata.length > 0) {
                        const folder = zip.folder(`images/${folderName}`);
                        for (const meta of categoryMetadata) {
                            try {
                                // Get blob from IndexedDB
                                const photoData = await getBlobFromIndexedDB(meta.id);
                                if (photoData && photoData.blob) {
                                    // Add blob directly to ZIP
                                    folder.file(meta.filename, photoData.blob);
                                }
                            } catch (error) {
                                console.error(`Error adding photo ${meta.filename} to ZIP:`, error);
                            }
                        }
                    }
                }

                // Add config.js file
                const configCode = document.getElementById('configCode').value;
                zip.folder('js').file('config.js', configCode);

                // Add README with instructions
                const readme = `# Photo Package - Ready to Deploy

## What's in this package?

This ZIP file contains:
- All your photos organized in the images/ folders
- Updated config.js file
- This README with deployment instructions

## How to deploy these changes:

### Option 1: Quick Deploy (Recommended)
1. Extract this ZIP file
2. Copy the \`images/\` and \`js/\` folders to your repository
3. When prompted, choose to replace/merge existing folders
4. Open terminal/command prompt in your repository folder
5. Run these commands:
   \`\`\`
   git add .
   git commit -m "Update portfolio photos"
   git push
   \`\`\`
6. Wait 1-2 minutes for GitHub Pages to deploy
7. Visit your site to see the changes!

### Option 2: Manual Verification
1. Extract this ZIP file
2. Copy each image file to its corresponding folder in your repo:
   - images/track/ ‚Üí Track photos
   - images/soccer/ ‚Üí Soccer photos
   - images/football/ ‚Üí Football photos
   - images/basketball/ ‚Üí Basketball photos
   - images/best-of/ ‚Üí Best Of photos
3. Replace js/config.js with the new config.js file
4. Verify files are in the correct locations
5. Commit and push:
   \`\`\`
   git add .
   git commit -m "Update portfolio photos"
   git push
   \`\`\`

## Photo Summary

Generated on: ${new Date().toLocaleString()}

${Object.entries(categories).map(([category, folderName]) => {
    const count = (photos[category] || []).length;
    return `- ${folderName}: ${count} photo${count !== 1 ? 's' : ''}`;
}).join('\n')}

Total: ${totalPhotos} photo${totalPhotos !== 1 ? 's' : ''}

## Need Help?

If you encounter any issues:
1. Make sure you're in your repository folder
2. Check that Git is installed (\`git --version\`)
3. Verify you have access to push to the repository
4. See ADMIN_GUIDE.md in your repository for more details

---

Generated by Cooper of the Crop Admin Panel
`;
                
                zip.file('README-DEPLOYMENT.txt', readme);

                // Generate ZIP file
                const content = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                // Download the ZIP file
                const url = URL.createObjectURL(content);
                triggerDownload(url, `portfolio-photos-${new Date().toISOString().split('T')[0]}.zip`);
                URL.revokeObjectURL(url);

                showNotification(`‚úì Package downloaded! Contains ${totalPhotos} photo${totalPhotos !== 1 ? 's' : ''}.`, 'success');
            } catch (error) {
                console.error('Error creating ZIP:', error);
                showNotification('‚ùå Failed to create package. Try downloading config and photos separately.', 'error');
            }
        }

        // Download deployment instructions as a fallback
        function downloadDeploymentInstructions() {
            const metadata = JSON.parse(localStorage.getItem('adminPhotosMetadata') || '{}');
            const totalPhotos = Object.values(metadata).reduce((sum, arr) => sum + arr.length, 0);
            
            const categories = {
                track: 'track',
                soccer: 'soccer',
                football: 'football',
                basketball: 'basketball',
                bestOf: 'best-of'
            };

            const instructions = `# Photo Deployment Instructions

## Overview
You have ${totalPhotos} photo${totalPhotos !== 1 ? 's' : ''} ready to deploy to your portfolio.

## Photo Summary
${Object.entries(categories).map(([category, folderName]) => {
    const count = (metadata[category] || []).length;
    return `- ${folderName}: ${count} photo${count !== 1 ? 's' : ''}`;
}).join('\n')}

## Deployment Steps

### Step 1: Save Photos
1. Go to the "Manage Photos" section in the admin panel
2. For each category with photos:
   - Click on the category tab
   - Right-click each photo and select "Save Image As..."
   - Save to a folder on your computer (organize by category)

### Step 2: Copy Photos to Repository
1. Open your repository folder on your computer
2. Navigate to the images/ folder
3. Copy your saved photos to the appropriate subfolders:
   - Track photos ‚Üí images/track/
   - Soccer photos ‚Üí images/soccer/
   - Football photos ‚Üí images/football/
   - Basketball photos ‚Üí images/basketball/
   - Best Of photos ‚Üí images/best-of/

### Step 3: Update Configuration
The config.js file has already been downloaded separately.
1. Replace your repository's js/config.js with the downloaded file

### Step 4: Deploy to GitHub
1. Open terminal/command prompt in your repository folder
2. Run these commands:
   \`\`\`
   git add .
   git commit -m "Update portfolio photos"
   git push
   \`\`\`
3. Wait 1-2 minutes for GitHub Pages to deploy
4. Visit your website to see the changes

## Filenames
Make sure the filenames match exactly (case-sensitive):

${Object.entries(categories).map(([category, folderName]) => {
    const categoryMetadata = metadata[category] || [];
    if (categoryMetadata.length === 0) return '';
    return `### ${folderName}:\n${categoryMetadata.map(p => `- ${p.filename}`).join('\n')}`;
}).filter(Boolean).join('\n\n')}

## Need Help?
- Check that filenames match exactly (including extensions)
- Verify photos are in the correct folders
- Make sure you have permission to push to the repository
- See ADMIN_GUIDE.md in your repository for more details

---

Generated by Cooper of the Crop Admin Panel on ${new Date().toLocaleString()}
`;

            const blob = new Blob([instructions], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            triggerDownload(url, 'DEPLOYMENT-INSTRUCTIONS.txt');
            URL.revokeObjectURL(url);
        }

        // ========== GitHub API Integration ==========
        
        // GitHub repository configuration
        const GITHUB_OWNER = 'CooperHofmann';
        const GITHUB_REPO = 'cooperofthecrop.github.io';
        const GITHUB_BRANCH = 'main'; // or 'master' depending on your default branch

        // Save GitHub token to localStorage
        function saveGitHubToken() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                showNotification('‚ùå Please enter a GitHub token', 'error');
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                showNotification('‚ö†Ô∏è Token should start with "ghp_" or "github_pat_"', 'error');
                return;
            }

            localStorage.setItem('githubToken', token);
            showNotification('‚úì GitHub token saved securely in your browser!', 'success');
        }

        // Show instructions for creating GitHub token
        function showTokenInstructions() {
            const instructions = `
HOW TO CREATE A GITHUB PERSONAL ACCESS TOKEN:

1. Go to GitHub.com and log in to your account
2. Click your profile picture (top right) ‚Üí Settings
3. Scroll down and click "Developer settings" (bottom left)
4. Click "Personal access tokens" ‚Üí "Tokens (classic)"
5. Click "Generate new token" ‚Üí "Generate new token (classic)"
6. Name it: "Portfolio Admin Panel"
7. Select expiration (recommend: 90 days)
8. Check these permissions:
   ‚úì repo (Full control of private repositories)
9. Click "Generate token" at the bottom
10. COPY THE TOKEN IMMEDIATELY (you won't see it again!)
11. Paste it in the field above and click "Save Token"

‚ö†Ô∏è IMPORTANT: Keep your token secret! Don't share it with anyone.
Your token is stored only in your browser's localStorage.
            `.trim();

            alert(instructions);
        }

        // Deploy directly to GitHub using GitHub API
        async function deployDirectlyToGitHub() {
            const statusDiv = document.getElementById('deployStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'var(--light-gray)';
            statusDiv.innerHTML = '‚è≥ Starting deployment...';

            // Get GitHub token
            const token = localStorage.getItem('githubToken');
            if (!token) {
                statusDiv.style.background = 'rgba(204, 0, 0, 0.1)';
                statusDiv.innerHTML = '‚ùå No GitHub token found. Please enter and save your token first.';
                showNotification('‚ùå GitHub token required', 'error');
                return;
            }

            // Get photos metadata from localStorage
            const metadata = JSON.parse(localStorage.getItem('adminPhotosMetadata') || '{}');
            const totalPhotos = Object.values(metadata).reduce((sum, arr) => sum + arr.length, 0);
            
            if (totalPhotos === 0) {
                statusDiv.style.background = 'rgba(204, 0, 0, 0.1)';
                statusDiv.innerHTML = '‚ùå No photos to deploy. Please upload some photos first.';
                showNotification('‚ùå No photos to deploy', 'error');
                return;
            }

            try {
                statusDiv.innerHTML = '‚è≥ Connecting to GitHub...';
                
                // Get current branch SHA
                const branchResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/git/refs/heads/${GITHUB_BRANCH}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!branchResponse.ok) {
                    throw new Error(`Failed to get branch info: ${branchResponse.status} ${branchResponse.statusText}`);
                }

                const branchData = await branchResponse.json();
                const currentCommitSha = branchData.object.sha;

                statusDiv.innerHTML = '‚è≥ Getting repository tree...';

                // Get current commit tree
                const commitResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/git/commits/${currentCommitSha}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!commitResponse.ok) {
                    throw new Error(`Failed to get commit: ${commitResponse.status}`);
                }

                const commitData = await commitResponse.json();
                const baseTreeSha = commitData.tree.sha;

                statusDiv.innerHTML = '‚è≥ Preparing files for upload...';

                // Create blobs for all photos and config
                const treeItems = [];
                const categories = {
                    track: 'track',
                    soccer: 'soccer',
                    football: 'football',
                    basketball: 'basketball',
                    bestOf: 'best-of'
                };

                let uploadedCount = 0;
                
                // Upload photos
                for (const [category, folderName] of Object.entries(categories)) {
                    const categoryMetadata = metadata[category] || [];
                    
                    for (const meta of categoryMetadata) {
                        statusDiv.innerHTML = `‚è≥ Uploading photo ${++uploadedCount} of ${totalPhotos}...`;
                        
                        try {
                            // Get blob from IndexedDB
                            const photoData = await getBlobFromIndexedDB(meta.id);
                            if (!photoData || !photoData.blob) {
                                console.error(`Photo ${meta.filename} not found in IndexedDB`);
                                continue;
                            }
                            
                            // Convert blob to base64
                            const dataUrl = await blobToDataURL(photoData.blob);
                            const base64Content = dataUrl.split(',')[1];
                            
                            // Create blob for photo
                            const blobResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/git/blobs`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Accept': 'application/vnd.github.v3+json',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    content: base64Content,
                                    encoding: 'base64'
                                })
                            });

                            if (!blobResponse.ok) {
                                throw new Error(`Failed to create blob for ${meta.filename}: ${blobResponse.status}`);
                            }

                            const blobData = await blobResponse.json();
                            
                            treeItems.push({
                                path: `images/${folderName}/${meta.filename}`,
                                mode: '100644',
                                type: 'blob',
                                sha: blobData.sha
                            });
                        } catch (error) {
                            console.error(`Error uploading photo ${meta.filename}:`, error);
                        }
                    }
                }

                statusDiv.innerHTML = '‚è≥ Uploading configuration file...';

                // Create blob for config.js
                const configCode = document.getElementById('configCode').value;
                const configBlobResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/git/blobs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: btoa(encodeURIComponent(configCode).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1))),
                        encoding: 'base64'
                    })
                });

                if (!configBlobResponse.ok) {
                    throw new Error(`Failed to create blob for config.js: ${configBlobResponse.status}`);
                }

                const configBlobData = await configBlobResponse.json();
                treeItems.push({
                    path: 'js/config.js',
                    mode: '100644',
                    type: 'blob',
                    sha: configBlobData.sha
                });

                statusDiv.innerHTML = '‚è≥ Creating commit...';

                // Create new tree
                const treeResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/git/trees`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        base_tree: baseTreeSha,
                        tree: treeItems
                    })
                });

                if (!treeResponse.ok) {
                    throw new Error(`Failed to create tree: ${treeResponse.status}`);
                }

                const treeData = await treeResponse.json();

                // Create new commit
                const newCommitResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/git/commits`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update portfolio: Add ${totalPhotos} photo${totalPhotos !== 1 ? 's' : ''} via Admin Panel`,
                        tree: treeData.sha,
                        parents: [currentCommitSha]
                    })
                });

                if (!newCommitResponse.ok) {
                    throw new Error(`Failed to create commit: ${newCommitResponse.status}`);
                }

                const newCommitData = await newCommitResponse.json();

                statusDiv.innerHTML = '‚è≥ Pushing to GitHub...';

                // Update branch reference
                const updateRefResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/git/refs/heads/${GITHUB_BRANCH}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sha: newCommitData.sha,
                        force: false
                    })
                });

                if (!updateRefResponse.ok) {
                    throw new Error(`Failed to update branch: ${updateRefResponse.status}`);
                }

                statusDiv.style.background = 'rgba(0, 170, 0, 0.2)';
                statusDiv.innerHTML = `
                    <div style="text-align: center;">
                        <h3 style="color: var(--success); margin-bottom: 10px;">üéâ Deployment Successful!</h3>
                        <p style="margin-bottom: 15px;">
                            ‚úì Uploaded ${totalPhotos} photo${totalPhotos !== 1 ? 's' : ''}<br>
                            ‚úì Updated config.js<br>
                            ‚úì Committed to ${GITHUB_BRANCH} branch<br>
                        </p>
                        <p style="font-size: 14px; color: var(--gray);">
                            Your changes are live! GitHub Pages will update in 1-2 minutes.<br>
                            <a href="https://${GITHUB_OWNER.toLowerCase()}.github.io/" target="_blank" style="color: var(--blue);">View your website ‚Üí</a>
                        </p>
                    </div>
                `;
                
                showNotification(`üéâ Successfully deployed ${totalPhotos} photo${totalPhotos !== 1 ? 's' : ''} to GitHub!`, 'success');

            } catch (error) {
                console.error('Deployment error:', error);
                statusDiv.style.background = 'rgba(204, 0, 0, 0.1)';
                statusDiv.innerHTML = `
                    <h3 style="color: var(--danger); margin-bottom: 10px;">‚ùå Deployment Failed</h3>
                    <p style="margin-bottom: 10px;">Error: ${error.message}</p>
                    <p style="font-size: 12px; color: var(--gray);">
                        Common issues:<br>
                        ‚Ä¢ Invalid or expired GitHub token<br>
                        ‚Ä¢ Token doesn't have "repo" permission<br>
                        ‚Ä¢ Repository name or owner is incorrect<br>
                        ‚Ä¢ Network connection issues
                    </p>
                    <button class="btn" onclick="showTokenInstructions()" style="margin-top: 10px;">‚ùì How to fix?</button>
                `;
                showNotification('‚ùå Deployment failed. See details above.', 'error');
            }
        }

        // Notification System
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            if (type === 'error') {
                notification.classList.add('error');
            }
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
